<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do App</title>
    <style>
        :root {
            --bg-color: #f4f4f4;
            --container-bg: white;
            --text-color: #333;
            --border-color: #ddd;
            --button-bg: #28a745;
            --button-hover-bg: #218838;
            --delete-btn-bg: #dc3545;
            --delete-btn-hover-bg: #c82333;
            --edit-btn-bg: #007bff;
            --edit-btn-hover-bg: #0056b3;
            --completed-color: #888;
            --high-priority: #ff4d4d;
            --medium-priority: #ffcc00;
            --low-priority: #4caf50;
        }

        [data-theme="dark"] {
            --bg-color: #222;
            --container-bg: #333;
            --text-color: #f4f4f4;
            --border-color: #555;
            --completed-color: #aaa;
            --high-priority: #ff6666;
            --medium-priority: #ffd700;
            --low-priority: #66cc66;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 90vw;
            margin: 2rem auto;
            padding: 1rem;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        h1 {
            text-align: center;
            font-size: clamp(1.5rem, 5vw, 2rem);
        }

        .todo-container {
            background: var(--container-bg);
            padding: clamp(1rem, 3vw, 1.5rem);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .theme-toggle {
            text-align: right;
            margin-bottom: 1rem;
        }

        .theme-toggle button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--edit-btn-bg);
            color: white;
        }

        .theme-toggle button:hover {
            background-color: var(--edit-btn-hover-bg);
        }

        .input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .sort-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
            position: relative;
        }

        .sort-button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--edit-btn-bg);
            color: white;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
        }

        .sort-button:hover {
            background-color: var(--edit-btn-hover-bg);
        }

        .sort-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .sort-menu.show {
            display: block;
        }

        .sort-menu button {
            display: block;
            width: 100%;
            padding: 0.5rem 1rem;
            border: none;
            background: none;
            color: var(--text-color);
            text-align: left;
            cursor: pointer;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
        }

        .sort-menu button:hover {
            background-color: var(--border-color);
        }

        input[type="text"], input[type="date"], select {
            flex: 1;
            min-width: 150px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        input[type="date"], select {
            max-width: 150px;
        }

        input[type="date"]::before, select:invalid {
            color: #999;
        }

        button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--button-bg);
            color: white;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
        }

        button:hover {
            background-color: var(--button-hover-bg);
        }

        .task-list {
            list-style: none;
            padding: 0;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .task-item.completed span {
            text-decoration: line-through;
            color: var(--completed-color);
        }

        .task-item input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        .task-item input[type="text"], .task-item select {
            min-width: 150px;
            margin-right: 0.5rem;
        }

        .task-text {
            flex: 1;
            min-width: 150px;
        }

        .due-date, .priority {
            font-size: 0.9rem;
            color: var(--text-color);
            margin-left: 0.5rem;
        }

        .priority.high {
            color: var(--high-priority);
            font-weight: bold;
        }

        .priority.medium {
            color: var(--medium-priority);
            font-weight: bold;
        }

        .priority.low {
            color: var(--low-priority);
            font-weight: bold;
        }

        .delete-btn {
            background-color: var(--delete-btn-bg);
            margin-left: 0.5rem;
        }

        .delete-btn:hover {
            background-color: var(--delete-btn-hover-bg);
        }

        .edit-btn {
            background-color: var(--edit-btn-bg);
            margin-left: 0.5rem;
        }

        .edit-btn:hover {
            background-color: var(--edit-btn-hover-bg);
        }

        @media (max-width: 400px) {
            .task-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .task-item input[type="text"],
            .task-item select,
            .task-text {
                width: 100%;
            }

            .edit-btn, .delete-btn {
                width: 100%;
                margin-left: 0;
                margin-top: 0.5rem;
            }

            .sort-container {
                justify-content: flex-start;
            }

            .sort-menu {
                width: 100%;
                right: 0;
            }
        }
    </style>
</head>
<body>
    <h1>To-Do App</h1>
    <div class="theme-toggle">
        <button onclick="toggleTheme()">Toggle Dark Mode</button>
    </div>
    <div class="todo-container">
        <div class="input-container">
            <input type="text" id="taskInput" placeholder="Enter a new task">
            <input type="date" id="dueDateInput" placeholder="Optional due date">
            <select id="priorityInput">
                <option value="" disabled selected>Priority</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
            </select>
            <button onclick="addTask()">Add Task</button>
        </div>
        <div class="sort-container">
            <button class="sort-button" onclick="toggleSortMenu()">Sort By</button>
            <div class="sort-menu" id="sortMenu">
                <button onclick="sortTasks('dateAdded')">Date Added</button>
                <button onclick="sortTasks('dueDate')">Due Date</button>
                <button onclick="sortTasks('priority')">Priority</button>
            </div>
        </div>
        <ul id="taskList" class="task-list"></ul>
    </div>

    <script>
                // Load theme and tasks when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadSortPreference();
            loadTasks();
        });

        // Toggle between light and dark theme
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
        }

        // Load theme from localStorage
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
        }

        // Load sort preference from localStorage
        function loadSortPreference() {
            const savedSort = localStorage.getItem('sort') || 'dateAdded';
            // No need to set a dropdown value since we're using a button menu
        }

        // Toggle the sort menu visibility
        function toggleSortMenu() {
            const sortMenu = document.getElementById('sortMenu');
            sortMenu.classList.toggle('show');
        }

        // Add a new task by sending it to the backend
        async function addTask() {
            const taskInput = document.getElementById('taskInput');
            const dueDateInput = document.getElementById('dueDateInput');
            const priorityInput = document.getElementById('priorityInput');
            const taskText = taskInput.value.trim();
            if (taskText === '') return;

            const newTask = {
                text: taskText,
                dueDate: dueDateInput.value || null,
                priority: priorityInput.value || null,
                completed: false,
                dateAdded: new Date().toISOString()
            };

            try {
                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newTask)
                });
                if (response.ok) {
                    taskInput.value = '';
                    dueDateInput.value = '';
                    priorityInput.value = '';
                    renderTasks();
                } else {
                    console.error('Failed to add task');
                }
            } catch (err) {
                console.error('Error adding task:', err);
            }
        }

        // Fetch tasks from the backend
        async function getTasks() {
            try {
                const response = await fetch('/api/tasks');
                if (response.ok) {
                    return await response.json();
                }
                return [];
            } catch (err) {
                console.error('Error fetching tasks:', err);
                return [];
            }
        }

        // Sort tasks and update the sort preference
        function sortTasks(sortBy) {
            localStorage.setItem('sort', sortBy);
            document.getElementById('sortMenu').classList.remove('show');
            renderTasks();
        }

        // Render tasks to the page
        async function renderTasks() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            let tasks = await getTasks();
            const sortBy = localStorage.getItem('sort') || 'dateAdded';

            // Sort tasks client-side
            tasks.sort((a, b) => {
                if (sortBy === 'priority') {
                    const priorityOrder = { high: 1, medium: 2, low: 3, null: 4 };
                    return priorityOrder[a.priority || 'null'] - priorityOrder[b.priority || 'null'];
                } else if (sortBy === 'dueDate') {
                    if (!a.dueDate && !b.dueDate) return 0;
                    if (!a.dueDate) return 1;
                    if (!b.dueDate) return -1;
                    return new Date(a.dueDate) - new Date(b.dueDate);
                } else {
                    return new Date(a.dateAdded) - new Date(b.dateAdded);
                }
            });

            tasks.forEach((task) => {
                const li = document.createElement('li');
                li.className = 'task-item' + (task.completed ? ' completed' : '');

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = task.completed;
                checkbox.onclick = () => toggleTask(task._id);

                const taskSpan = document.createElement('span');
                taskSpan.textContent = task.text;
                taskSpan.className = 'task-text';

                const dueDateSpan = document.createElement('span');
                dueDateSpan.textContent = task.dueDate ? `Due: ${task.dueDate.split('T')[0]}` : '';
                dueDateSpan.className = 'due-date';

                const prioritySpan = document.createElement('span');
                prioritySpan.textContent = task.priority ? `Priority: ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}` : '';
                prioritySpan.className = task.priority ? `priority ${task.priority}` : 'priority';

                const editInput = document.createElement('input');
                editInput.type = 'text';
                editInput.value = task.text;
                editInput.style.display = 'none';

                const editDueDateInput = document.createElement('input');
                editDueDateInput.type = 'date';
                editDueDateInput.value = task.dueDate ? task.dueDate.split('T')[0] : '';
                editDueDateInput.style.display = 'none';

                const editPriorityInput = document.createElement('select');
                editPriorityInput.style.display = 'none';
                const priorities = ['', 'low', 'medium', 'high'];
                priorities.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p;
                    option.textContent = p ? p.charAt(0).toUpperCase() + p.slice(1) : 'None';
                    if (p === task.priority) option.selected = true;
                    editPriorityInput.appendChild(option);
                });

                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.className = 'edit-btn';
                editBtn.onclick = () => editTask(task._id, li, taskSpan, editInput, editDueDateInput, editPriorityInput, dueDateSpan, prioritySpan, editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.className = 'delete-btn';
                deleteBtn.onclick = () => deleteTask(task._id);

                li.appendChild(checkbox);
                li.appendChild(taskSpan);
                li.appendChild(dueDateSpan);
                li.appendChild(prioritySpan);
                li.appendChild(editInput);
                li.appendChild(editDueDateInput);
                li.appendChild(editPriorityInput);
                li.appendChild(editBtn);
                li.appendChild(deleteBtn);
                taskList.appendChild(li);
            });
        }

        // Edit a task by updating it on the backend
        async function editTask(id, li, taskSpan, editInput, editDueDateInput, editPriorityInput, dueDateSpan, prioritySpan, editBtn) {
            if (editBtn.textContent === 'Edit') {
                taskSpan.style.display = 'none';
                dueDateSpan.style.display = 'none';
                prioritySpan.style.display = 'none';
                editInput.style.display = 'inline-block';
                editDueDateInput.style.display = 'inline-block';
                editPriorityInput.style.display = 'inline-block';
                editBtn.textContent = 'Save';
                editInput.focus();
            } else {
                const newText = editInput.value.trim();
                if (newText === '') return;

                const updatedTask = {
                    text: newText,
                    dueDate: editDueDateInput.value || null,
                    priority: editPriorityInput.value || null
                };

                try {
                    const response = await fetch(`/api/tasks/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updatedTask)
                    });
                    if (response.ok) {
                        taskSpan.textContent = newText;
                        dueDateSpan.textContent = updatedTask.dueDate ? `Due: ${updatedTask.dueDate}` : '';
                        prioritySpan.textContent = updatedTask.priority ? `Priority: ${updatedTask.priority.charAt(0).toUpperCase() + updatedTask.priority.slice(1)}` : '';
                        prioritySpan.className = updatedTask.priority ? `priority ${updatedTask.priority}` : 'priority';
                        taskSpan.style.display = 'inline-block';
                        dueDateSpan.style.display = 'inline-block';
                        prioritySpan.style.display = 'inline-block';
                        editInput.style.display = 'none';
                        editDueDateInput.style.display = 'none';
                        editPriorityInput.style.display = 'none';
                        editBtn.textContent = 'Edit';
                        renderTasks();
                    } else {
                        console.error('Failed to update task');
                    }
                } catch (err) {
                    console.error('Error editing task:', err);
                }
            }
        }

        // Toggle task completion status
        async function toggleTask(id) {
            try {
                const tasks = await getTasks();
                const task = tasks.find(t => t._id === id);
                const updatedTask = { ...task, completed: !task.completed };
                const response = await fetch(`/api/tasks/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedTask)
                });
                if (response.ok) {
                    renderTasks();
                } else {
                    console.error('Failed to toggle task');
                }
            } catch (err) {
                console.error('Error toggling task:', err);
            }
        }

        // Delete a task
        async function deleteTask(id) {
            try {
                const response = await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    renderTasks();
                } else {
                    console.error('Failed to delete task');
                }
            } catch (err) {
                console.error('Error deleting task:', err);
            }
        }

        // Initial load of tasks
        function loadTasks() {
            renderTasks();
        }
    </script>
</body>
</html>